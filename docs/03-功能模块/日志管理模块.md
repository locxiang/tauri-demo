# 日志管理模块

## 📋 模块概述

日志管理模块采用**内存环形缓冲区 + 实时流式传输**架构，替代传统文件读取方式，提供零延迟的实时日志监控。

## 🏗️ 技术架构

### 核心设计
- **事件驱动**: 基于Tauri事件系统实时推送
- **内存优化**: 环形缓冲区固定内存使用
- **零文件I/O**: 完全基于内存的日志系统
- **类型安全**: Rust + TypeScript 端到端类型保障

### 系统架构
```
前端 Vue3 组件 ←→ Pinia Store ←→ Tauri Events ←→ Rust API ←→ 日志系统核心
```

## 🔧 核心组件

### 1. ModernLogSystem (应用层核心)
- **环形缓冲区**: 保持最近10000条日志，自动覆盖旧记录
- **广播机制**: 支持多订阅者的异步通知
- **线程安全**: 使用Arc+RwLock确保并发安全
- **实时推送**: 日志产生时立即推送到前端

### 2. CircularBuffer (数据结构)
- **O(1)插入**: 常数时间复杂度
- **固定内存**: 避免内存泄漏
- **高效读取**: 按时间倒序快速获取

### 3. LogEntry (数据模型)
包含ID、时间戳、级别、目标模块、消息内容、上下文信息、文件位置等字段。

### 4. MemoryLogCollector (收集器)
实现log::Log trait，拦截系统日志并转换为标准化LogEntry。

## 🌊 数据流机制

```
系统调用log!() → 收集器拦截 → 创建LogEntry → 存储到缓冲区 → 广播通知 → 前端实时显示
```

### 前端接收流程
1. 调用`subscribe_log_stream`订阅
2. 监听`log-stream`事件
3. 实时更新Vue组件状态
4. 自动滚动显示新日志

## 🔍 过滤系统

### 多层过滤架构
前端过滤器 → 后端过滤器 → 订阅者过滤 → 最终结果

### 支持的过滤条件
- **级别过滤**: Error, Warn, Info, Debug, Trace
- **关键词搜索**: 消息内容和模块名匹配
- **时间范围**: since/until时间戳过滤
- **模块过滤**: 按target模块路径过滤

## 📊 API接口

### 主要命令
| 命令 | 功能 | 参数 |
|------|------|------|
| `get_recent_logs` | 获取历史日志 | limit, filters |
| `subscribe_log_stream` | 订阅实时流 | window, filters |
| `unsubscribe_log_stream` | 取消订阅 | window |
| `clear_logs` | 清空缓冲区 | - |
| `get_log_stats` | 获取统计信息 | - |

### 前端Store方法
- `loadRecentLogs()`: 加载历史日志
- `startLogStream()`: 开启实时流
- `stopLogStream()`: 停止实时流
- `updateFilters()`: 更新过滤条件
- `clearLogs()`: 清空显示

## 🎨 前端实现

### Vue组件特性
- **实时状态指示**: 显示流运行状态
- **自动滚动**: 新日志自动滚动到底部
- **智能过滤**: 支持级别和关键词过滤
- **统计信息**: 实时显示各级别日志数量

### 自动滚动机制
双重监听确保实时滚动：监听`filteredLogs`变化和`logs`原始数据变化。

## ⚡ 性能优化

### 后端优化
- 环形缓冲区固定内存，O(1)插入
- 异步处理，非阻塞操作
- 线程安全的无锁数据结构
- 高效的多订阅者广播

### 前端优化
- Vue computed自动缓存过滤结果
- 防抖处理用户输入
- 自动限制前端显示条目数
- 可选的虚拟滚动支持

## 🔧 配置管理

### 系统配置
- 后端缓冲区容量: 10000条
- 前端显示限制: 1000条
- 广播通道缓冲: 1000条
- 日志级别: Debug

### 运行时配置
- 最大显示条目数可调
- 自动滚动开关
- 过滤防抖延迟
- 自动刷新间隔

## 🚀 使用指南

### 基本操作
1. **启动实时流**: 点击"开启实时流"
2. **查看历史**: 点击"刷新日志"
3. **过滤日志**: 选择级别和输入关键词
4. **清空显示**: 清除当前显示内容

### 高级功能
- 多窗口独立订阅
- 自定义过滤条件
- 实时统计信息
- 缓冲区使用监控

## 🔍 故障排除

### 常见问题
- **实时流不工作**: 检查日志系统初始化状态，重启应用
- **内存使用过高**: 检查缓冲区配置，减少显示条目数
- **滚动不流畅**: 启用虚拟滚动，优化过滤条件

### 调试方法
```bash
# 开发模式启动
pnpm tauri dev

# 检查日志系统状态
invoke('get_log_stats')
```

## 📈 扩展计划

### 计划功能
- 日志导出(JSON/CSV)
- 高级过滤规则(正则表达式)
- 日志告警机制
- 性能指标监控
- 分析报表功能

### 技术改进
- 虚拟滚动优化
- 日志压缩存储
- 分布式日志收集
- 实时日志分析

## 🎯 总结

现代化日志管理模块通过内存环形缓冲区和实时流式传输，实现了零延迟日志显示、高性能固定内存使用、模块化易扩展设计，为系统监控和调试提供了强大支持。
